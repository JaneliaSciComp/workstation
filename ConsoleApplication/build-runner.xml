<?xml version="1.0" encoding="UTF-8"?>
<!--
This is necessary so that the environments required by Janelia's build system
and those of the NetBeans system can be properly negotiated.  This is a sort
of adapter.
-->
<project name="run-console-build" default="build">
    <property environment="env"/>
    <!-- Create a unique user directory for IDE runs. -->
    <property name="git.branch" value="anyBranch"/>
    <exec executable="git" outputproperty="git.branch"
          failifexecutionfails="false">
        <arg line="rev-parse --abbrev-ref HEAD"/>
    </exec>
    <echo message="Current branch: ${git.branch}"/>
    <property name="test.user.dir" value="${env.USERPROFILE}/rcp_testuserdir_${git.branch}" />
    <property file="../buildprocess/config/${user.name}.properties" />
    <target name="build" description="Build using ant target" depends="prop-copy,internal-jar-copy">
        <echoproperties/>
        <ant antfile="build.xml" target="build">
            <property name="nbplatform.default.netbeans.dest.dir" value="${basedir}" />
            <property name="nbplatform.default.harness.dir" value="${basedir}/harness" />
        </ant>
    </target>

    <target name="nbms" description="Target to build modules locally.  Assumes no install of NetBeans IDE">
        <!--<echoproperties/>-->
        <ant antfile="build.xml" target="nbms">
            <property name="nbplatform.default.netbeans.dest.dir" value="${basedir}" />
            <property name="nbplatform.default.harness.dir" value="${basedir}/harness" />
        </ant>
    </target>

    <target name="deploy-nbms-staging">
        <property name="ssh.common.params" value="jacs@jacs-webdav"/>
        <property name="scp.common.params" value=""/>
        <echo message="Testing connection" />
        <echo message="SSH Common Params ${ssh.common.params} for ${ssh}"/>
        <exec executable="${ssh}" description="Testing connection"
              outputproperty="exec.output" failonerror="true">
            <arg line="${ssh.common.params} ls -ld /tmp"/>
        </exec>

        <!--clean out old modules -->
        <echo message="Removing remote Staging modules" />
        <exec executable="${ssh}" description="Removing Staging modules">
            <arg line="${ssh.common.params} rm -fr /var/www/html/staging/*"/>
        </exec>

        <!--copy new modules -->
        <echo message="Copying new modules to Staging" />
        <echo message="SCP Common Params ${scp.common.params} for ${scp}"/>
        <exec executable="bash" description="Copying new modules to Staging">
            <arg line="-c '${scp} -r ${basedir}/build/updates/* jacs@jacs-webdav:/var/www/html/staging/.'"/>
        </exec>
        <echo message="Done : ${exec.output}"  />
        <echo message="Done : ${exec.error}"  />
    </target>

    <target name="deploy-nbms-production">
        <property name="ssh.common.params" value="jacs@jacs-webdav"/>
        <property name="scp.common.params" value=""/>
        <echo message="Testing connection" />
        <echo message="SSH Common Params ${ssh.common.params} for ${ssh}"/>
        <exec executable="${ssh}" description="Testing connection"
              outputproperty="exec.output" failonerror="true">
            <arg line="${ssh.common.params} ls -ld /tmp"/>
        </exec>

        <!--clean out old modules -->
        <echo message="Removing remote Production modules" />
        <exec executable="${ssh}" description="Removing Production modules">
            <arg line="${ssh.common.params} rm -fr /var/www/html/workstation/*"/>
        </exec>

        <!--copy new modules -->
        <echo message="Copying new modules to Production" />
        <echo message="SCP Common Params ${scp.common.params} for ${scp}"/>
        <exec executable="bash" description="Copying new modules to Production">
            <arg line="-c '${scp} -r ${basedir}/build/updates/* jacs@jacs-webdav:/var/www/html/workstation/.'"/>
        </exec>
        <echo message="Done : ${exec.output}"  />
        <echo message="Done : ${exec.error}"  />
    </target>

    <target name="create-platform" description="Target to build platform locally">
        <!--<echoproperties/>-->
        <ant antfile="build.xml" target="create-platform">
            <property name="nbplatform.default.netbeans.dest.dir" value="${basedir}" />
            <property name="nbplatform.default.harness.dir" value="${basedir}/harness" />
        </ant>
    </target>

    <target name="prop-copy" description="Get latest versions of properties files from the non-NetBeans Projects.">
        <copy file="${basedir}/../shared/conf/jacs.properties" todir="${basedir}/SharedModelComputeWrapper/src" />
    </target>

    <target name="internal-jar-copy" description="Get latest versions of internally-developed project jars.">
        <property name="internal-jar-release" value="${basedir}/SharedModelComputeWrapper/release/modules/ext"/>
        <mkdir dir="${internal-jar-release}"/>
        <copy file="${basedir}/../shared/build/jars/jacs-shared.jar" todir="${internal-jar-release}" />
        <copy file="${basedir}/../model/build/jars/jacs-model.jar" todir="${internal-jar-release}" />
        <copy file="${basedir}/../compute/build/jars/compute-client.jar" todir="${internal-jar-release}" />
    </target>

    <target name="clean" description="Clean">
        <ant antfile="build.xml" target="clean">
            <property name="nbplatform.default.netbeans.dest.dir" value="${basedir}" />
            <property name="nbplatform.default.harness.dir" value="${basedir}/harness" />
        </ant>
        <echo message="Expected: 4 errors involving absense of directory 'ConsoleApplication/build/cluster', which was to be deleted anyway."/>
        <!--<exec-target target="clean"/>-->
    </target>

    <target name="run" description="Launch application">
        <ant antfile="build.xml" target="run">
            <property name="nbplatform.default.netbeans.dest.dir" value="${basedir}" />
            <property name="nbplatform.default.harness.dir" value="${basedir}/harness" />
        </ant>
    </target>

    <target name="debug" description="Debug application">
        <ant antfile="build.xml" target="run">
            <property name="nbplatform.default.netbeans.dest.dir" value="${basedir}" />
            <property name="nbplatform.default.harness.dir" value="${basedir}/harness" />
            <property name="run.args.extra" value="-J-Xmx16000m -J-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005"/>
        </ant>
    </target>

    <macrodef name="exec-target" description="Carry Out Target via Exec">
        <attribute name="target"/>

        <sequential>
            <!-- NOTE: failonerror is possible, here, but it hides the error text. -->
            <exec executable="${env.antexec}" outputproperty="antout">
                <arg value="-Dnbplatform.default.netbeans.dest.dir=${basedir}"/>
                <arg value="-Dnbplatform.default.harness.dir=${basedir}/harness" />
                <arg value="-f"/>
                <arg value="build.xml"/>
                <arg value="@{target}"/>
            </exec>
            <echo message="Ant Build: ${antout}"/>
            <condition property="subbuildsuccess">
                <contains string="${antout}" substring="BUILD SUCCESSFUL" casesensitive="true" />
            </condition>
            <fail unless="${subbuildsuccess}" message="Unsuccessful"/>
        </sequential>
    </macrodef>

    <!-- This attempt fails, because underneath it all, another ant -f is being invoked.
    <target name="build-installers-anttask" description="Build installers for all platforms.">
        <ant antfile="${basedir}/harness/nbi/stub/template.xml" target="build">
            <property name="nbi.stub.location" value="${basedir}/harness/nbi/stub"/>
            <property name="nbi.engine.jar" value="${basedir}/harness/modules/ext/nbi-engine.jar"/>
            <property name="suite.nbi.product.uid" value="janeliaworkstation"/>
            <property name="nbi.icon.file" value="branding/core/core.jar/org/netbeans/core/startup/frame48.gif"/>
            <property name="suite.location" value="${basedir}"/>
            <property name="generate.installer.for.platforms" value="windows linux macosx"/>
            <property name="nbi.ant.tasks.jar" value="${basedir}/harness/modules/ext/nbi-ant-tasks.jar"/>
            <property name="generator-jdk-location-forward-slashes" value="${java.home}/.."/><
            <property name="nbi.dock.icon.file" value="${basedir}/harness/etc/applicationIcon.icns"/>
            <property name="nbi.stub.common.location" value="${basedir}/harness/nbi/.common"/>
            <property name="nbi.registries.management.jar" value="${basedir}/harness/modules/ext/nbi-registries-management.jar"/>
            <property name="pack200.enabled" value="false"/>
        </ant>
    </target>
    -->

    <target name="build-installers" description="Build installers: first define antexec">
        <!--
           This is the full command line used to build installers, from my NetBeans installation, at time of
           writing (May 14,2014).

             ant -f "/Applications/NetBeans/NetBeans 7.4.app/Contents/Resources/NetBeans/harness/nbi/stub/template.xml"
             "-Dnbi.stub.location=/Applications/NetBeans/NetBeans 7.4.app/Contents/Resources/NetBeans/harness/nbi/stub"
             "-Dnbi.engine.jar=/Applications/NetBeans/NetBeans 7.4.app/Contents/Resources/NetBeans/harness/modules/ext/nbi-engine.jar"
             "-Dnbi.stub.common.location=/Applications/NetBeans/NetBeans 7.4.app/Contents/Resources/NetBeans/harness/nbi/.common"
             -Dsuite.nbi.product.uid=janeliaworkstation
             -Dnbi.icon.file=/Users/fosterl/NetBeansProjects/alignment_board_LLF/janelia-workstation/ConsoleApplication/branding/core/core.jar/org/netbeans/core/startup/frame48.gif
             -Dsuite.location=/Users/fosterl/NetBeansProjects/alignment_board_LLF/janelia-workstation/ConsoleApplication
             "-Dgenerate.installer.for.platforms=windows linux macosx"
             "-Dnbi.ant.tasks.jar=/Applications/NetBeans/NetBeans 7.4.app/Contents/Resources/NetBeans/harness/modules/ext/nbi-ant-tasks.jar"
             -Dgenerator-jdk-location-forward-slashes=/Library/Java/JavaVirtualMachines/jdk1.7.0_67.jdk/Contents/Home
             "-Dnbi.dock.icon.file=/Applications/NetBeans/NetBeans 7.4.app/Contents/Resources/NetBeans/harness/etc/applicationIcon.icns"
             -Dpack200.enabled=false "-Dnbi.registries.management.jar=/Applications/NetBeans/NetBeans 7.4.app/Contents/Resources/NetBeans/harness/modules/ext/nbi-registries-management.jar"
              build
        -->
        <echo message="This target still requires presetting antexec."/>
        <exec executable="${env.antexec}" outputproperty="antout">
            <!-- First arg is used explicitly in NetBeans, but found unneeded and difficult to set, here. -->
            <!--<arg value="-Dgenerator-jdk-location-forward-slashes=/Library/Java/JavaVirtualMachines/jdk1.7.0_67.jdk/Contents/Home "-->
            <arg value="-Dnbplatform.default.netbeans.dest.dir=${basedir}"/>
            <arg value="-Dnbplatform.default.harness.dir=${basedir}/harness" />
            <arg value="-Dgenerate.installer.for.platforms=windows linux macosx"/>
            <arg value="-Dsuite.nbi.product.uid=janeliaworkstation"/>
            <arg value="-Dsuite.location=${basedir}"/>
            <arg value="-Dpack200.enabled=false"/>
            <arg value="-Dnbi.stub.location=${basedir}/harness/nbi/stub"/>
            <arg value="-Dnbi.engine.jar=${basedir}/harness/modules/ext/nbi-engine.jar"/>
            <arg value="-Dnbi.stub.common.location=${basedir}/harness/nbi/.common"/>
            <arg value="-Dnbi.icon.file=${basedir}/janeliaws.icns"/>
            <arg value="-Dnbi.ant.tasks.jar=${basedir}/harness/modules/ext/nbi-ant-tasks.jar"/>
            <arg value="-Dnbi.dock.icon.file=${basedir}/janeliaws.icns"/>
            <arg value="-Dnbi.registries.management.jar=${basedir}/harness/modules/ext/nbi-registries-management.jar" />
            <arg value="-f"/>
            <arg value="${basedir}/harness/nbi/stub/template.xml"/>
            <arg value="build"/>
        </exec>
        <echo message="Ant Build: ${antout}"/>
        <condition property="subbuildsuccess">
            <contains string="${antout}" substring="BUILD SUCCESSFUL" casesensitive="true" />
        </condition>
        <fail unless="${subbuildsuccess}" message="Unsuccessful"/>
    </target>

    <target name="build-mac" description="Builds a full mac app with canonical directory structure: first define antexec">
        <!-- This fails, because of files not found. -->
        <!--<ant antfile="build.xml" target="build-mac">-->
            <!--<property name="nbplatform.default.netbeans.dest.dir" value="${basedir}"/>-->
            <!--<property name="nbplatform.default.harness.dir" value="${basedir}/harness" />-->
        <!--</ant>-->
        <echo message="This target still requires presetting antexec."/>
        <exec-target target="build-mac"/>
    </target>

    <target name="build-zip" description="Builds a Zip File with Windows exe's: first define antexec">
        <!-- This attempt fails because of files not found. -->
        <!--<ant antfile="build.xml" target="build-zip"/>-->
        <echo message="This target still requires presetting antexec."/>
        <exec-target target="build-zip"/>
    </target>

    <target name="deploy" description="Invoke NetBeans deploy task: first define antexec">
        <exec-target target="deploy"/>
    </target>
</project>
